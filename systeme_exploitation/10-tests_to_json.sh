#!/bin/bash

success_tests=()
failure_tests=()

for log_file in TP_ex10/teraterm_*.log
do
    imei_line=$(grep -A1 'SIM800 IMEI is:' "$log_file")
    imei=$(echo "$imei_line" | tail -1 | awk '{print $NF}' | tr -d '\r')
    date=$(echo "$imei_line" | head -1 | awk '{print $1}' | tr -d '[]')

    if grep -q 'TEST SUCCEEDED' "$log_file"; then
        rssi=$(grep 'GSM SIGNAL IS GOOD AND RSSI IS:' "$log_file" | awk -F ':' '{print $NF}' | tr -d ', ')
        success_tests+=("{\"imei\":\"$imei\",\"date\":\"$date\",\"rssi\":\"$rssi\"}")
    else
        failure_tests+=("{\"imei\":\"$imei\",\"date\":\"$date\"}")
    fi
done

json_string="{\"success\":[$(IFS=,; echo "${success_tests[*]}")],\"failure\":[$(IFS=,; echo "${failure_tests[*]}")]}"

# Remove control characters
json_string=$(echo "$json_string" | tr -d '\000-\037')

echo "$json_string" | jq '.' > teraterm_output.json